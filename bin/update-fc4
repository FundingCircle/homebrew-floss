#!/bin/bash

## NB: Run this from the root of the repo!

set -e

tags=$(curl --silent "https://api.github.com/repos/fundingcircle/fc4-framework/tags")

tag_name=$(echo "$tags" | jq -r '.[0].name')
version=${tag_name:8}

tag_sha=$(echo "$tags" | jq -r '.[0].commit.sha')
short_tag_sha=${tag_sha:0:7}

# Example URL:
#   https://github.com/FundingCircle/fc4-framework/releases/download/release_2019-07-10_1868/fc4-tool-macos-amd64-e0af83d.tar.gz

linux_filename="fc4-tool-linux-amd64-$short_tag_sha.tar.gz"
macos_filename="fc4-tool-macos-amd64-$short_tag_sha.tar.gz"
base_url="https://github.com/FundingCircle/fc4-framework/releases/download/"
linux_url="$base_url/$tag_name/$linux_filename"
macos_url="$base_url/$tag_name/$macos_filename"

for os in macos linux; do
  fv="${os}_filename"
  filename=${!fv}
  if [ ! -f "$filename" ]; then
    uv="${os}_url"
    url=${!uv}
    wget --no-verbose --show-progress "$url"
  fi
done

linux_sha=$(sha256sum "$linux_filename" | cut -f 1 -d " ")
macos_sha=$(sha256sum "$macos_filename" | cut -f 1 -d " ")

echo '# NB: DO NOT EDIT THIS FILE IT IS GENERATED FROM A TEMPLATE!' > fc4.rb

sed -e "s/\${i}/1/" -e "s/\${VERSION}/$version/g" \
    -e "s/\${TAG_NAME}/$tag_name/g" \
    -e "s/\${LINUX_FILENAME}/$linux_filename/g" \
    -e "s/\${MACOS_FILENAME}/$macos_filename/g" \
    -e "s/\${LINUX_SHA}/$linux_sha/g" \
    -e "s/\${MACOS_SHA}/$macos_sha/g" \
    templates/fc4.template.rb >> fc4.rb
