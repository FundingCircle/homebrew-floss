#!/bin/bash

## NB: Run this from the root of the repo!

set -e

# This used to retrieve the /tags resource but for some reason those aren’t sorted the same as
# the /releases resource. If we want the latest release, we need to use this resource.
releases=$(curl --silent "https://api.github.com/repos/fundingcircle/fc4-framework/releases?per-page=1")
tag_name=$(echo "$releases" | jq -r '.[0].tag_name')
version=${tag_name:8} # remove the prefix `release_` from the tag name to yield the version identifier

# Example URL:
#   https://github.com/FundingCircle/fc4-framework/releases/download/release_2019-07-10_1868/fc4-tool-macos-amd64-2019.09.10-e0af83d.tar.gz

linux_filename="fc4-tool-linux-amd64-${version}.tar.gz"
macos_filename="fc4-tool-macos-amd64-${version}.tar.gz"
base_url="https://github.com/FundingCircle/fc4-framework/releases/download"
linux_url="$base_url/$tag_name/$linux_filename"
macos_url="$base_url/$tag_name/$macos_filename"

# This is a little silly; it’s really only here to prevent shellcheck from thinking that these two
# variables are unused.
echo "$linux_url and $macos_url" >> /dev/null

for os in macos linux; do
  fv="${os}_filename"
  filename=${!fv}
  if [ ! -f "$filename" ]; then
    uv="${os}_url"
    url=${!uv}
    wget --no-verbose --show-progress "$url"
  fi
done

linux_sha=$(sha256sum "$linux_filename" | cut -f 1 -d " ")
macos_sha=$(sha256sum "$macos_filename" | cut -f 1 -d " ")

echo '# NB: DO NOT EDIT THIS FILE IT IS GENERATED FROM A TEMPLATE!' > fc4.rb

sed -e "s/\${i}/1/" -e "s/\${VERSION}/$version/g" \
    -e "s/\${TAG_NAME}/$tag_name/g" \
    -e "s/\${LINUX_FILENAME}/$linux_filename/g" \
    -e "s/\${MACOS_FILENAME}/$macos_filename/g" \
    -e "s/\${LINUX_SHA}/$linux_sha/g" \
    -e "s/\${MACOS_SHA}/$macos_sha/g" \
    templates/fc4.template.rb >> fc4.rb
