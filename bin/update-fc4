#!/bin/bash

## NB: Run this from the root of the repo!

set -eu -o pipefail

# This used to retrieve the /tags resource but for some reason those arenâ€™t sorted the same as
# the /releases resource. If we want the latest release, we need to use this resource.
releases=$(curl --silent "https://api.github.com/repos/fundingcircle/fc4-framework/releases?per_page=1")
package_url=$(echo "$releases" | jq -r '.[0].assets[0].browser_download_url')
tag_name=$(echo "$releases" | jq -r '.[0].tag_name')
version=${tag_name:8} # remove the prefix `release_` from the tag name to yield the version identifier

# Example URL:
#   https://github.com/FundingCircle/fc4-framework/releases/download/release_2019.09.10-e0af83d/fc4-tool-2019.09.10-e0af83d.tar.gz

package_sha=$(curl -L "$package_url" | sha256sum | cut -f 1 -d " ")

echo '# NB: DO NOT EDIT THIS FILE IT IS GENERATED FROM A TEMPLATE!' > fc4.rb

sed -e "s~\${VERSION}~${version}~g" \
    -e "s~\${PACKAGE_URL}~${package_url}~g" \
    -e "s~\${PACKAGE_SHA}~${package_sha}~g" \
    templates/fc4.template.rb >> fc4.rb
