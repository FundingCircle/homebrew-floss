version: 2.1

executors:
  macos:
    environment:
      HOMEBREW_NO_AUTO_UPDATE: 1
    macos:
      xcode: << parameters.version >>
    parameters:
      version:
        description: "Xcode version"
        default: "10.2.1"
        type: string

jobs:
  audit:
    executor: macos
    parameters:
      version:
        description: "Xcode version"
        default: "10.2.1"
        type: string
    steps:
      - checkout
      - restore_cache:
          key: homebrew-floss-{{ checksum ".circleci/config.yml" }}
      - run:
          name: Audit formulae
          command: |
            for formula in ./*.rb
            do
              brew audit --strict $formula
            done
      - save_cache:
          key: homebrew-floss-{{ checksum ".circleci/config.yml" }}
          paths:
            - /usr/local/Homebrew/Library/Homebrew/vendor/bundle
  test:
    executor: macos
    parameters:
      version:
        description: "Xcode version"
        default: "10.2.1"
        type: string
    steps:
      - checkout
      - run:
          name: Test formulae
          command: |
            for formula in ./*.rb
            do
              brew install --display-times --verbose $formula
              brew test --verbose $formula
            done

workflows:
  ci:
    jobs:
      # These jobs will fail until the format of fc4-tool release names
      # is changed to remove underscores in the version component.
      # This change is being tracked in:
      # https://github.com/FundingCircle/fc4-framework/issues/193
      #- audit:
      #    name: "audit-macos-high-sierra"
      #    version: "10.2.3"
      #- audit:
      #    name: "audit-macos-mojave"
      #    version: "10.3.0"
      - test:
          name: "test-macos-high-sierra"
          version: "10.2.3"
      - test:
          name: "test-macos-mojave"
          version: "10.3.0"
